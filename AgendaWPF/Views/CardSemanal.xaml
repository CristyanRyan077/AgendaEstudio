<UserControl x:Name="Cards"
             x:Class="AgendaWPF.Views.CardSemanal"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"  xmlns:hl="clr-namespace:AgendaWPF.Models"
             xmlns:local="clr-namespace:AgendaWPF.Views" xmlns:hc="https://handyorg.github.io/handycontrol"
             mc:Ignorable="d" xmlns:shared="clr-namespace:AgendaShared.DTOs;assembly=AgendaShared" xmlns:controles="clr-namespace:AgendaWPF.Controles"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes" xmlns:viewmodels="clr-namespace:AgendaWPF.ViewModels" d:DataContext="{d:DesignInstance Type=viewmodels:AgendaViewModel}"
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Resources>
        <DropShadowEffect x:Key="DropShadow"
                      BlurRadius="5"
                      ShadowDepth="2"
                      Opacity="0.3" />
        <!-- Adicionando o recurso ValueText para corrigir o erro XDG0006 -->
        <Style x:Key="ValueText" TargetType="TextBlock">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="Foreground" Value="#222"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>
       
    </UserControl.Resources>

    <Grid>

        <!-- Grid com duas linhas: cabeçalho (navegação) e conteúdo (ItemsControl) -->
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <DockPanel DockPanel.Dock="Top" LastChildFill="False" Margin="8,0,8,4">
                    <Border Background="#EEFFFFCC" CornerRadius="8" Padding="8"
                            HorizontalAlignment="Right">

                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" >
                            <TextBlock Text="Buscar:" Margin="0,0,6,0" VerticalAlignment="Center"/>
                            <hc:TextBox Width="220" Text="{Binding FindTermo, UpdateSourceTrigger=PropertyChanged}" hc:InfoElement.Placeholder="Busca por Nome/Id">
                                <hc:TextBox.InputBindings>
                                    <!-- Enter = Próximo; Shift+Enter = Anterior -->
                                    <KeyBinding Key="Enter" Command="{Binding FindProximoCommand}"/>
                                </hc:TextBox.InputBindings>
                            </hc:TextBox>
                            <TextBlock Text="{Binding FindIndiceLabel}" Margin="8,0" VerticalAlignment="Center"/>
                            <Button Content="↑" Command="{Binding FindAnteriorCommand}" Margin="2,0"/>
                            <Button Content="↓" Command="{Binding FindProximoCommand}" Margin="2,0"/>
                            <Button Content="✕" Command="{Binding FindLimparCommand}" Margin="6,0,0,0"/>
                        </StackPanel>

                    </Border>
                    
                </DockPanel>



                <!-- Cabeçalho de navegação da semana -->

                <Border Grid.Row="0" Margin="0,10,0,0" Padding="12"  BorderThickness="0,0,0,1">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="600"/>
                            <ColumnDefinition Width="200"/>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="200"/>
                        </Grid.ColumnDefinitions>



                        <hc:DatePicker Grid.Column="2"
                               SelectedDate="{Binding DataFiltroSelecionada, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                               DisplayDateStart="2020-01-01"
                               hc:InfoElement.Placeholder="Ir para data:"
                               Width="180" VerticalAlignment="Center"/>

                        <Button Grid.Column="1"
                        Content="← Semana Anterior"
                        Command="{Binding SemanaAnteriorCommand}"
                        FontWeight="Bold"
                        FontSize="12"
                        Background="#FFDDDD"
                        BorderBrush="Black"
                        VerticalAlignment="Center"/>



                        <Button Grid.Column="4"
                        Content="Próxima Semana →"
                        Command="{Binding ProximaSemanaCommand}"
                        FontWeight="Bold"
                        FontSize="12"
                        Background="#DDFFDD"
                        BorderBrush="Black"
                        VerticalAlignment="Center"/>
                    </Grid>
                </Border>


                <ItemsControl x:Name="DiasSemanaItemsControl" Grid.Row="1" ItemsSource="{Binding DiasSemana}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>

                            <UniformGrid Columns="3" Rows="3"/>

                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>


                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="6">

                                <!-- Nome do dia (fora do card) -->
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <TextBlock Text="{Binding Data, StringFormat=dd/MM/yyyy}" HorizontalAlignment="Left" Background="#99FFFFFF" FontSize="16" Margin="0 0 120 0"/>
                                    <TextBlock Text="{Binding Nome, UpdateSourceTrigger=PropertyChanged}" 
                                FontSize="20"
                                FontWeight="Bold"
                                Foreground="Black"
                                HorizontalAlignment="Center"
                                Width="152" Height="32"
                                Background="#FF13FF00"
                                TextAlignment="Center" Margin="0,0,210,0"
                                FontFamily="Segoe UI Black" VerticalAlignment="Top"/>
                                    <Button Content="➕"
                                        Tag="{Binding Data}"
                                        Click="BtnAgenda_Click"
                                        FontSize="14" Height="30"
                                        Background="Green" Margin="0,0,10,0"
                                        HorizontalAlignment="Right"/>

                                </StackPanel>


                                <Border Background="#88FFFFFF" 
                            CornerRadius="10"
                            Padding="4"
                            Height="420" 
                            BorderBrush="#DDD"
                            BorderThickness="1">

                                    <hc:Card HorizontalAlignment="Stretch">
                                        <!-- Agendamentos do dia -->
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ItemsControl x:Name="AgendamentosItemsControl" ItemsSource="{Binding Agendamentos}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Padding="6" 
                                                            CornerRadius="12"
                                                            BorderBrush="#DDD"
                                                            BorderThickness="1"
                                                            Margin="0,0,0,10" MouseDown="AgendamentoBorder_MouseDown"
                                                            Background="White"
                                                            Effect="{StaticResource DropShadow}">
                                                            

                                                            <Grid>
                                                                <StackPanel>
                                                                    <StackPanel Orientation="Horizontal" Margin="0 0 0 0">
                                                                        
                                                                        <TextBlock  hl:TextHighlight.Text="{Binding ClienteId, StringFormat='#{0}'}" FontSize="16"
                                                                                    hl:TextHighlight.Term="{Binding DataContext.FindTermo, ElementName=Cards}"
                                                                                    hl:TextHighlight.IsCurrent="{Binding IsCurrentFindHit}"/>
                                                                        
                                                                        <TextBlock Text=" | " Foreground="Gray" Margin="4,0"/>

                                                                        <TextBlock hl:TextHighlight.Text="{Binding Cliente.Nome}"
                                                                                   hl:TextHighlight.Term="{Binding DataContext.FindTermo, ElementName=Cards}"
                                                                                   hl:TextHighlight.IsCurrent="{Binding IsCurrentFindHit}"
                                                                                   FontFamily="Segoe UI" FontWeight="Bold" FontSize="16"/>

                                                                        <TextBlock Text=" | " Foreground="Gray" Margin="4,0"/>

                                                                        <TextBlock  hl:TextHighlight.Text="{Binding Cliente.Telefone}" FontSize="14"
                                                                                    hl:TextHighlight.Term="{Binding DataContext.FindTermo, ElementName=Cards}"
                                                                                    hl:TextHighlight.IsCurrent="{Binding IsCurrentFindHit}"/>
                                                                        <TextBlock Text=" | " Foreground="Gray" Margin="4,0"/>

                                                                        <StackPanel Orientation="Horizontal">
                                                                            <TextBlock Text="{Binding Crianca.Nome}" Margin="0,0,5,0" FontSize="14"/>
                                                                            <TextBlock Text="{Binding MesversarioFormatado}" FontSize="14"/>
                                                                        </StackPanel>
                                                                    </StackPanel>



                                                                    <StackPanel Orientation="Horizontal" Grid.Column="0" Margin="0 0 0 5">

                                                                    </StackPanel>



                                                                    <StackPanel Orientation="Horizontal">
                                                                        <TextBlock Text="{Binding Servico.Nome}" FontWeight="Bold" FontSize="13" Margin="0 0 10 4" FontFamily="Helvetica"/>
                                                                        <TextBlock Text="{Binding ValorPago, StringFormat=R$ {0:N2}}" FontWeight="Bold" FontSize="13" Margin="0 0 5 0" FontFamily="Helvetica">
                                                                            <TextBlock.Style>
                                                                                <Style TargetType="TextBlock">
                                                                                    <Setter Property="Foreground" Value="Red"/>
                                                                                    <Style.Triggers>
                                                                                        <DataTrigger Binding="{Binding EstaPago}" Value="True">
                                                                                            <Setter Property="Foreground" Value="Green"/>
                                                                                        </DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </TextBlock.Style>
                                                                        </TextBlock>
                                                                        <TextBlock Text=" / " Foreground="Gray"/>
                                                                        <TextBlock Text="{Binding Valor, StringFormat=R$ {0:N2}}" FontWeight="Bold" FontSize="13" Margin="0 0 0 4" FontFamily="Helvetica"/>
                                                                    </StackPanel>

                                                                    <StackPanel  Orientation="Horizontal">
                                                                        <TextBlock Text="{Binding Horario, StringFormat={}{0:hh\\:mm}}" FontSize="14"/>
                                                                        <TextBlock Text=" | " Foreground="Gray" Margin="0,-2,0,0" FontSize="16"/>
                                                                        <TextBlock Text="{Binding Tema}" Margin="0,0,5,0" FontSize="14"/>
                                                                        

                                                                    </StackPanel>
                                                                    
                                                                   


                                                                </StackPanel>

                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </hc:Card>
                                </Border>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>


            </Grid>

        </ScrollViewer>
        <Grid x:Name="OverlayHost"
                Panel.ZIndex="99"  d:Visibility="Collapsed"
                Visibility="{Binding DataContext.MostrarDetalhes,
                            ElementName=Cards,
                            Converter={StaticResource BoolToVisibilityConverter}}">
            

            <!-- Backdrop escurecido (clica para fechar) -->
            <Border x:Name="Backdrop"
           Opacity="{Binding DataContext.MostrarDetalhes,
          ElementName=Cards,
          Converter={StaticResource BoolToOpacity}}"
          Background="#80000000">

                <Border.InputBindings>
                    <MouseBinding MouseAction="LeftClick"
                Command="{Binding FecharDetalhesCommand}"/>
                </Border.InputBindings>
            </Border>

            <Border x:Name="DetailsPane"
                  Width="640"
                  HorizontalAlignment="Left"
                  Background="{DynamicResource {x:Static SystemColors.ControlLightLightBrushKey}}"
                  Padding="18"
                  CornerRadius="10"
                  Effect="{StaticResource DropShadow}">
                <Border.RenderTransform>
                    <TranslateTransform  X="{Binding DataContext.MostrarDetalhes,
                ElementName=Cards,
                Converter={StaticResource BoolToOffset}}"/>
                </Border.RenderTransform>

                <!-- Novo layout: header com avatar + resumo, área de informações, observações e tabs -->
                <ContentControl  Content="{Binding AgendamentoSelecionado}">
                    <ContentControl.ContentTemplate>
                        <DataTemplate DataType="{x:Type viewmodels:AgendaViewModel}">
                            <!-- Exemplo de layout limpo -->
                            <Grid>
                                <Grid.Resources>
                                    <Style x:Key="LabelTitle" TargetType="TextBlock">
                                        <Setter Property="Foreground" Value="#666"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                        <Setter Property="FontSize" Value="12"/>
                                    </Style>
                                    <Style x:Key="ChipStyle" TargetType="Border">
                                        <Setter Property="Background" Value="#E0E0E0"/>
                                        <Setter Property="CornerRadius" Value="12"/>
                                        <Setter Property="Padding" Value="6,2"/>
                                        <Setter Property="HorizontalAlignment" Value="Left"/>
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                    </Style>
                                    
                                </Grid.Resources>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <Grid Grid.Row="0" Margin="0,0,0,12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Avatar simples com iniciais -->
                                    <Border Width="72" Height="72" CornerRadius="36" Background="#FF607D8B" VerticalAlignment="Center" HorizontalAlignment="Left">
                                        <TextBlock Text="{Binding Cliente.Nome}" Foreground="White" FontWeight="Bold" FontSize="18" VerticalAlignment="Center" HorizontalAlignment="Center" TextTrimming="CharacterEllipsis">
                                            
                                        </TextBlock>
                                    </Border>

                                    <!-- Resumo -->
                                    <StackPanel Grid.Column="1" Margin="12,0,12,0" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding Cliente.Nome}" FontSize="20" FontWeight="Bold" Foreground="#111"/>
                                        <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                                            <TextBlock Text="📞" Margin="0,2,6,0"/>
                                            <TextBlock Text="{Binding Cliente.Telefone}" Style="{StaticResource ValueText}" Margin="0,0,12,0"/>
                                            <TextBlock Text="🧾" Margin="0,0,6,0"/>
                                            <TextBlock Text="{Binding Servico.Nome}" Style="{StaticResource ValueText}" />
                                        </StackPanel>
                                    </StackPanel>

                                    <!-- Ações -->
                                    <StackPanel Grid.Column="2" VerticalAlignment="Top" HorizontalAlignment="Right">
                                        
                                        <Button Background="Red" Content="X" FontSize="16" Padding="12,0" Margin="90,0,0,10"
                                                Command="{Binding DataContext.FecharDetalhesCommand, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type local:CardSemanal}}}" />
                                        <Button Content="✎ Editar" Click="Editar_Click" Background="AliceBlue" Width="90" Margin="0,0,0,8" />
                                    </StackPanel>
                                </Grid>

                                <!-- Linha de informações importantes -->
                                <Border Grid.Row="1" Background="#F5F7FA" Padding="10" CornerRadius="6" Margin="0,0,0,12">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Grid.Column="0" Orientation="Vertical">
                                            <TextBlock Text="Data" Style="{StaticResource LabelTitle}"/>
                                            <TextBlock Text="{Binding Data, StringFormat={}{0:dd/MM/yyyy}}" Style="{StaticResource ValueText}" Margin="0,4,0,8"/>

                                            <TextBlock Text="Horário" Style="{StaticResource LabelTitle}"/>
                                            <TextBlock Text="{Binding Horario, StringFormat=\{0:hh\\:mm\}h}" Style="{StaticResource ValueText}" Margin="0,4,0,0"/>
                                        </StackPanel>

                                        <StackPanel Grid.Column="1" Orientation="Vertical">
                                            <TextBlock Text="Valor" Style="{StaticResource LabelTitle}"/>
                                            <TextBlock Text="{Binding Valor, StringFormat={}R{0:C}}" Style="{StaticResource ValueText}" Margin="0,4,0,8"/>

                                            <TextBlock Text="Pago" Style="{StaticResource LabelTitle}"/>
                                            <Border Style="{StaticResource ChipStyle}" Padding="6">
                                                <TextBlock Text="{Binding ValorPago,StringFormat={}R{0:C}}" FontSize="14" x:Name="PaymentStatusText" FontWeight="Bold"/>
                                            </Border>
                 
                                            
                                        </StackPanel>
                                    </Grid>
                                </Border>
                                <Border Grid.Row="2" MaxWidth="300" HorizontalAlignment="Left" Background="#F5F7FA" Padding="10" CornerRadius="6" Margin="0,0,0,12">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Grid.Column="0" Orientation="Vertical">
                                            <TextBlock Text="Crianca" Style="{StaticResource LabelTitle}"/>
                                            <TextBlock Text="{Binding Crianca.Nome}" Style="{StaticResource ValueText}" FontSize="16" Margin="0,4,0,8"/>
                                        </StackPanel>

                                        <StackPanel Grid.Column="1" Orientation="Vertical">
                                            <TextBlock Text="  Idade" Style="{StaticResource LabelTitle}"/>
                                            <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                <TextBlock Text="{Binding Crianca.Idade}" Margin="0,0,4,0" Style="{StaticResource ValueText}"/>
                                                <TextBlock Text="{Binding Crianca.IdadeUnidade}" Style="{StaticResource ValueText}"/>
                                            </StackPanel>
        
                                        </StackPanel>
                                    </Grid>
                                </Border>

                                <!-- Observações -->
                                <StackPanel Grid.Row="3" Margin="0,0,0,12">
                                    <TextBlock Text="Anotações:" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,6"/>
                                    <Border Background="#FFF" Padding="8" CornerRadius="6" BorderBrush="#EEE" BorderThickness="1" MaxHeight="120">
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <TextBlock Text="{Binding Observacao}" TextWrapping="Wrap"/>
                                        </ScrollViewer>
                                    </Border>
                                </StackPanel>

                                <!-- Tabs (Pagamentos / Histórico) -->
                                <TabControl Grid.Row="4" Margin="0">
                                    <TabItem Header="Pagamentos">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <DataGrid ItemsSource="{Binding Pagamentos}"
                                                      AutoGenerateColumns="False"
                                                      CanUserAddRows="False"
                                                      CanUserDeleteRows="False"
                                                      HeadersVisibility="Column"
                                                      Background="Transparent" BorderBrush="#DDD"
                                                      BorderThickness="1" RowHeight="36"
                                                      ColumnHeaderHeight="40"
                                                      FontSize="14" FontFamily="Segoe UI"
                                                      GridLinesVisibility="None"
                                                      SnapsToDevicePixels="True" Margin="0,0,0,8">
                                                <DataGrid.Effect>
                                                    <DropShadowEffect BlurRadius="6" ShadowDepth="2" Opacity="0.15"/>
                                                </DataGrid.Effect>
                                                <DataGrid.Resources>
                                                    <Style TargetType="DataGridColumnHeader">
                                                        <Setter Property="Background" Value="#2D89EF"/>
                                                        <Setter Property="Foreground" Value="White"/>
                                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                                        <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                                        <Setter Property="Padding" Value="8"/>
                                                    </Style>
                                                </DataGrid.Resources>
                                                <DataGrid.Columns>
                                                    <DataGridTextColumn Header="Data" Binding="{Binding DataPagamento, StringFormat={}{0:dd/MM/yyyy}}"/>
                                                    <DataGridTextColumn Header="Valor" Binding="{Binding Valor, StringFormat={}{0:C}}"/>
                                                    <DataGridTextColumn Header="Método" Binding="{Binding Metodo}"/>
                                                    <DataGridTextColumn Header="Observações" Binding="{Binding Observacao}" Width="*"/>
                                                </DataGrid.Columns>
                                            </DataGrid>

                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Grid.Row="1" Margin="0,8,0,0">
                                                <Button Content="Adicionar" Click="Button_Click" Margin="0,0,10,0" Background="Green"/>
                                                <Button Content="Apagar" Background="Red"/>
                                            </StackPanel>
                                        </Grid>
                                    </TabItem>

                                    <TabItem Header="Histórico">
                                        <controles:HistoricoCliente/>
                                    </TabItem>
                                </TabControl>
                            </Grid>
                        </DataTemplate>
                    </ContentControl.ContentTemplate>
                </ContentControl>
            </Border>
        </Grid>
    </Grid>
    
</UserControl>
