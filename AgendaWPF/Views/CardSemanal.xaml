<UserControl x:Name="Cards"
             x:Class="AgendaWPF.Views.CardSemanal"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AgendaWPF.Views" xmlns:hc="https://handyorg.github.io/handycontrol"
             mc:Ignorable="d" xmlns:shared="clr-namespace:AgendaShared.DTOs;assembly=AgendaShared"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes" xmlns:viewmodels="clr-namespace:AgendaWPF.ViewModels" d:DataContext="{d:DesignInstance Type=viewmodels:AgendaViewModel}"
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Resources>
        <DropShadowEffect x:Key="DropShadow"
                      BlurRadius="5"
                      ShadowDepth="2"
                      Opacity="0.3" />
    </UserControl.Resources>

    <Grid>

        <!-- Grid com duas linhas: cabeçalho (navegação) e conteúdo (ItemsControl) -->
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>



                <!-- Cabeçalho de navegação da semana -->

                <Border Grid.Row="0" Margin="0,10,0,0" Padding="12"  BorderThickness="0,0,0,1">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="600"/>
                            <ColumnDefinition Width="200"/>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="200"/>
                        </Grid.ColumnDefinitions>



                        <hc:DatePicker Grid.Column="2"
                               SelectedDate="{Binding DataFiltroSelecionada, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                               DisplayDateStart="2020-01-01"
                               hc:InfoElement.Placeholder="Ir para data:"
                               Width="180" VerticalAlignment="Center"/>

                        <Button Grid.Column="1"
                        Content="← Semana Anterior"
                        Command="{Binding SemanaAnteriorCommand}"
                        FontWeight="Bold"
                        FontSize="12"
                        Background="#FFDDDD"
                        BorderBrush="Black"
                        VerticalAlignment="Center"/>



                        <Button Grid.Column="4"
                        Content="Próxima Semana →"
                        Command="{Binding ProximaSemanaCommand}"
                        FontWeight="Bold"
                        FontSize="12"
                        Background="#DDFFDD"
                        BorderBrush="Black"
                        VerticalAlignment="Center"/>
                    </Grid>
                </Border>


                <ItemsControl Grid.Row="1" ItemsSource="{Binding DiasSemana}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>

                            <UniformGrid Columns="3" Rows="3"/>

                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>


                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="6">

                                <!-- Nome do dia (fora do card) -->
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <TextBlock Text="{Binding Data, StringFormat=dd/MM/yyyy}" HorizontalAlignment="Left" Background="#99FFFFFF" FontSize="16" Margin="0 0 120 0"/>
                                    <TextBlock Text="{Binding Nome, UpdateSourceTrigger=PropertyChanged}" 
                                FontSize="20"
                                FontWeight="Bold"
                                Foreground="Black"
                                HorizontalAlignment="Center"
                                Width="152" Height="32"
                                Background="#FF13FF00"
                                TextAlignment="Center" Margin="0,0,210,0"
                                FontFamily="Segoe UI Black" VerticalAlignment="Top"/>
                                    <Button Content="➕"
                                        Tag="{Binding Data}"
                                        Click="BtnAgenda_Click"
                                        FontSize="14" Height="30"
                                        Background="Green" Margin="0,0,10,0"
                                        HorizontalAlignment="Right"/>

                                </StackPanel>


                                <Border Background="#88FFFFFF" 
                            CornerRadius="10"
                            Padding="4"
                            Height="420" 
                            BorderBrush="#DDD"
                            BorderThickness="1">

                                    <hc:Card HorizontalAlignment="Stretch" Opacity="1.0">
                                        <!-- Agendamentos do dia -->
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding Agendamentos}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Padding="6" 
                                                            CornerRadius="12"
                                                            BorderBrush="#DDD"
                                                            BorderThickness="1"
                                                            Margin="0,0,0,10" MouseDown="AgendamentoBorder_MouseDown"
                                                            Background="White"
                                                            Effect="{StaticResource DropShadow}">

                                                            <Grid>
                                                                <StackPanel Visibility="{Binding DataContext.ModoFotos,
                                                                    RelativeSource={RelativeSource AncestorType=Window},
                                                                    Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                                                    <StackPanel Orientation="Horizontal" Margin="0 0 0 0">
                                                                        <TextBlock Text="{Binding Cliente.Id}"  FontSize="16"/>
                                                                        <TextBlock Text=" | " Foreground="Gray" Margin="4,0"/>

                                                                        <TextBlock Text="{Binding Cliente.Nome}"                                                                  
                                                                    FontFamily="Segoe UI" FontWeight="Bold" FontSize="16"/>

                                                                        <TextBlock Text=" | " Foreground="Gray" Margin="4,0"/>

                                                                        <TextBlock Text="{Binding Cliente.Telefone}" FontSize="14"/>
                                                                        <TextBlock Text=" | " Foreground="Gray" Margin="4,0"/>

                                                                        <StackPanel Orientation="Horizontal">
                                                                            <TextBlock Text="{Binding Crianca.Nome}" Margin="0,0,5,0" FontSize="14"/>
                                                                            <TextBlock Text="{Binding MesversarioFormatado}" FontSize="14"/>
                                                                        </StackPanel>
                                                                    </StackPanel>



                                                                    <StackPanel Orientation="Horizontal" Grid.Column="0" Margin="0 0 0 5">

                                                                    </StackPanel>



                                                                    <StackPanel Orientation="Horizontal">
                                                                        <TextBlock Text="{Binding Servico.Nome}" FontWeight="Bold" FontSize="13" Margin="0 0 10 4" FontFamily="Helvetica"/>
                                                                        <TextBlock Text="{Binding ValorPago, StringFormat=R$ {0:N2}}" FontWeight="Bold" FontSize="13" Margin="0 0 5 0" FontFamily="Helvetica">
                                                                            <TextBlock.Style>
                                                                                <Style TargetType="TextBlock">
                                                                                    <Setter Property="Foreground" Value="Red"/>
                                                                                    <Style.Triggers>
                                                                                        <DataTrigger Binding="{Binding EstaPago}" Value="True">
                                                                                            <Setter Property="Foreground" Value="Green"/>
                                                                                        </DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </TextBlock.Style>
                                                                        </TextBlock>
                                                                        <TextBlock Text=" / " Foreground="Gray"/>
                                                                        <TextBlock Text="{Binding Valor, StringFormat=R$ {0:N2}}" FontWeight="Bold" FontSize="13" Margin="0 0 0 4" FontFamily="Helvetica"/>
                                                                    </StackPanel>

                                                                    <StackPanel Orientation="Horizontal">
                                                                        <TextBlock Text="{Binding Horario, StringFormat={}{0:hh\\:mm}}" FontSize="14"/>
                                                                        <TextBlock Text=" | " Foreground="Gray" Margin="0,-2,0,0" FontSize="16"/>
                                                                        <TextBlock Text="{Binding Tipo}" Margin="2,-2,0,0" FontSize="16"/>
                                                                        <TextBlock Text=" | " Foreground="Gray"/>
                                                                        <TextBlock Text="{Binding Tema}" FontSize="14"/>
                                                                        <TextBlock Text="{Binding Cliente.Observacao}" FontSize="12"/>

                                                                    </StackPanel>
                                                                    <Border HorizontalAlignment="Left"
                                                                        Visibility="{Binding TemReserva, Converter={StaticResource BoolToVisibilityConverter}}">
                                                                        <StackPanel Background="LightGray" Orientation="Horizontal">
                                                                            <TextBlock FontWeight="Bold" Text="Reserva: "/>
                                                                            <TextBlock FontWeight="Bold" Text="{Binding MesReserva}" Margin="0,0,5,0"/>
                                                                            <TextBlock Foreground="Green" FontWeight="Bold" Text="{Binding ValorReserva, StringFormat=R$ {0:N2}}"/>
                                                                        </StackPanel>
                                                                    </Border>


                                                                </StackPanel>

                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </hc:Card>
                                </Border>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>


            </Grid>

        </ScrollViewer>
        <Grid x:Name="OverlayHost"
                Panel.ZIndex="99"
                Visibility="{Binding DataContext.MostrarDetalhes,
                            ElementName=Cards,
                            Converter={StaticResource BoolToVisibilityConverter}}">

            <!-- Backdrop escurecido (clica para fechar) -->
            <Border x:Name="Backdrop"
           Opacity="{Binding DataContext.MostrarDetalhes,
          ElementName=Cards,
          Converter={StaticResource BoolToOpacity}}"
          Background="#80000000">

                <Border.InputBindings>
                    <MouseBinding MouseAction="LeftClick"
                Command="{Binding FecharDetalhesCommand}"/>
                </Border.InputBindings>
            </Border>


            <Border x:Name="DetailsPane"
                  Width="500"
                  HorizontalAlignment="Left"
                  Background="{DynamicResource {x:Static SystemColors.ControlLightLightBrushKey}}"
                  Padding="20"
                  Effect="{DynamicResource ElevationShadow}">
                <Border.RenderTransform>
                    <TranslateTransform  X="{Binding DataContext.MostrarDetalhes,
                ElementName=Cards,
                Converter={StaticResource BoolToOffset}}"/>
                </Border.RenderTransform>

                <!-- Conteúdo (subview com DataContext = AgendamentoSelecionado) -->
                <ContentControl Content="{Binding AgendamentoSelecionado}">
                    <ContentControl.ContentTemplate>
                        <DataTemplate DataType="{x:Type shared:AgendamentoDto}">
                            <!-- Exemplo de layout limpo -->
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding ClienteId, StringFormat='#{0:}'}" FontSize="16" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding Cliente.Nome}"
                          FontSize="22" FontWeight="Bold" Margin="5,0,10,4"/>
                                    <TextBlock Text="{Binding Cliente.Telefone}"
                          FontSize="18" VerticalAlignment="Center" FontWeight="Bold"/>
                                </StackPanel>

                                <Button Grid.Column="1"
                      Command="{Binding DataContext.FecharDetalhesCommand,
                                        RelativeSource={RelativeSource AncestorType=Window}}"
                      Content="Fechar" Padding="12,6" />

                                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,2,0,0">
                                    <TextBlock Text="{Binding Data, StringFormat='{}{0: dd/MM/yyyy}'}" FontSize="14" />
                                    <TextBlock Text=" • "/>
                                    <TextBlock Text="{Binding Horario,StringFormat=\{0:hh\\:mm\}h}" FontSize="14" />
                                    <TextBlock Text=" • "/>
                                    <TextBlock Text="{Binding Tema, TargetNullValue='Sem tema'}" />
                                </StackPanel>

                                <StackPanel Grid.Row="2" Margin="2,5,0,0">

                                    <TextBlock Text="{Binding Servico.Nome}" />
                                    <TextBlock Text="{Binding Pacote.Nome, TargetNullValue='—'}" />
                                    <TextBlock IsEnabled="False">
                          <Run Text="Valor: "/>
                          <Run Text="{Binding Valor, StringFormat={}{0:C}}"/>
                          <Run Text="  (Pago: "/>
                          <Run Text="{Binding ValorPago, Mode=OneWay, StringFormat={}{0:C}}"/>
                          <Run Text=")"/>
                                    </TextBlock>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Crianca: "/>
                                        <TextBlock Text="{Binding Crianca.Nome, TargetNullValue='—'}" Margin="0,0,5,0" />
                                        <TextBlock Text="{Binding MesversarioFormatado}"/>
                                    </StackPanel>

                                </StackPanel>

                                <!-- Tabs simples (detalhes / pagamentos / histórico) -->
                                <TabControl Grid.Row="3" Grid.ColumnSpan="2" Margin="0,16,0,0">
                                    <TabItem Header="Pagamentos">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="80"/>
                                            </Grid.RowDefinitions>
                                            <DataGrid ItemsSource="{Binding Pagamentos}"
                                            AutoGenerateColumns="False"
                                            CanUserAddRows="False"
                                            CanUserDeleteRows="False"
                                            HeadersVisibility="Column"
                                            Background="LightGray" BorderBrush="#DDD"
                                            BorderThickness="1" RowHeight="35"
                                            ColumnHeaderHeight="40"
                                            FontSize="14" FontFamily="Segoe UI"
                                            GridLinesVisibility="None"       
                                            SnapsToDevicePixels="True">
                                                <DataGrid.Effect>
                                                    <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.3"/>
                                                </DataGrid.Effect>
                                                <DataGrid.Resources>
                                                    <!-- Cabeçalhos -->
                                                    <Style TargetType="DataGridColumnHeader">
                                                        <Setter Property="Background" Value="#2D89EF"/>
                                                        <Setter Property="Foreground" Value="White"/>
                                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                                        <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                                        <Setter Property="Padding" Value="8"/>
                                                    </Style>
                                                    <!-- Linhas -->
                                                    <Style TargetType="DataGridRow">
                                                        <Setter Property="Cursor" Value="Hand"/>
                                                        <Setter Property="SnapsToDevicePixels" Value="True"/>
                                                        <Setter Property="ToolTip" Value="Clique para selecionar esta linha"/>
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="#E3F2FD"/>
                                                            </Trigger>
                                                            <Trigger Property="IsSelected" Value="True">
                                                                <Setter Property="Background" Value="#BBDEFB"/>
                                                                <Setter Property="Foreground" Value="Black"/>
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </DataGrid.Resources>
                                                <DataGrid.Columns>
                                                    <DataGridTextColumn Header="Data" Binding="{Binding DataPagamento, StringFormat={}{0:dd/MM/yyyy}}"/>
                                                    <DataGridTextColumn Header="Valor" Binding="{Binding Valor, StringFormat={}{0:C}}"/>
                                                    <DataGridTextColumn Header="Método" Binding="{Binding Metodo}"/>
                                                    <DataGridTextColumn Header="Observações" Binding="{Binding Observacao}" Width="*"/>
                                                </DataGrid.Columns>
                                            </DataGrid>
                                            <StackPanel Margin="150,0,0,0" Grid.Row="1" Orientation="Horizontal">
                                                <Button Content="Adicionar" Click="Button_Click" Margin="0,0,10,0" Background="Green"/>
                                                <Button Content="Apagar" Background="Red"/>
                                            </StackPanel>
                                        </Grid>


                                    </TabItem>
                                    <TabItem Header="Histórico">
                                        <!-- histórico do cliente -->
                                        <!-- ... -->
                                    </TabItem>
                                </TabControl>
                            </Grid>
                        </DataTemplate>
                    </ContentControl.ContentTemplate>
                </ContentControl>
            </Border>
        </Grid>
    </Grid>
    
</UserControl>
