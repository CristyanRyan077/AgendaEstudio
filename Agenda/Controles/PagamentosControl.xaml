<UserControl x:Class="AgendaNovo.Controles.PagamentosControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:hc="https://handyorg.github.io/handycontrol"
             xmlns:local="clr-namespace:AgendaNovo.Controles" 
             xmlns:viewmodels="clr-namespace:AgendaNovo.ViewModels" 
             d:DataContext="{d:DesignInstance Type=viewmodels:PagamentosViewModel}"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.InputBindings>
        <KeyBinding Key="Enter" Command="{Binding SalvarOuAdicionarHistoricoCommand}"/>
    </UserControl.InputBindings>

    <Grid Background="#2F2F2F">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- 0 HEADER -->
            <RowDefinition Height="Auto"/>
            <!-- 1 RESUMO -->
            <RowDefinition Height="Auto"/>
            <!-- 2 FORM ÚNICO (Pagamento/Produto) -->
            <RowDefinition Height="Auto"/>
            <!-- 3 (vazio, sobrou do layout antigo) -->
            <RowDefinition Height="Auto"/>
            <!-- 4 STATUS FOTOS -->
            <RowDefinition Height="*"/>
            <!-- 5 GRID HISTÓRICO -->
        </Grid.RowDefinitions>

        <!-- HEADER -->
        <DockPanel Grid.Row="0" LastChildFill="False" Margin="0,0,0,8">
            <StackPanel Orientation="Horizontal" Margin="12,0,0,0">
                <TextBlock Text="{Binding ClienteNome}" FontSize="18" FontFamily="#Heveltica" Foreground="White" Margin="0,0,12,0"/>
                <TextBlock Text="{Binding ServicoNome}" FontSize="12" Foreground="#DDD" Margin="0,0,12,0"/>
            </StackPanel>
        </DockPanel>

        <!-- RESUMO -->
        <UniformGrid Grid.Row="1" Columns="4" Margin="0,0,0,12">
            <Border Background="#3A3A3A" CornerRadius="10" Padding="10" Margin="4">
                <StackPanel>
                    <TextBlock Text="Valor" Foreground="#BBB"/>
                    <TextBlock Text="{Binding Valor, StringFormat=R$ {0:N2}}" Foreground="White" FontSize="20" FontWeight="Bold"/>
                </StackPanel>
            </Border>
            <Border Background="#3A3A3A" CornerRadius="10" Padding="10" Margin="4">
                <StackPanel>
                    <TextBlock Text="Pago" Foreground="#BBB"/>
                    <TextBlock Text="{Binding ValorPago, StringFormat=R$ {0:N2}}" Foreground="White" FontSize="20" FontWeight="Bold"/>
                </StackPanel>
            </Border>
            <Border Background="#3A3A3A" CornerRadius="10" Padding="10" Margin="4">
                <StackPanel>
                    <TextBlock Text="Falta" Foreground="#BBB"/>
                    <TextBlock Text="{Binding Falta, StringFormat=R$ {0:N2}}" Foreground="White" FontSize="20" FontWeight="Bold"/>
                </StackPanel>
            </Border>
            <Border Background="#3A3A3A" CornerRadius="10" Padding="10" Margin="4">
                <StackPanel>
                    <TextBlock Text="% Recebido" Foreground="#BBB"/>
                    <TextBlock Text="{Binding PercentualPago, StringFormat={}{0}%}" Foreground="White" FontSize="20" FontWeight="Bold"/>
                </StackPanel>
            </Border>
        </UniformGrid>

        <!-- FORMULÁRIO DE PAGAMENTO (2 colunas) -->
        <Border Grid.Row="2" Background="#3A3A3A" CornerRadius="12" Padding="16" Margin="0,0,0,6"
                HorizontalAlignment="Center" Width="600">
            <Grid Grid.IsSharedSizeScope="True" HorizontalAlignment="Center">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <!-- título / toggle -->
                    <RowDefinition Height="Auto"/>
                    <!-- linha 1 -->
                    <RowDefinition Height="Auto"/>
                    <!-- linha 2 -->
                    <RowDefinition Height="Auto"/>
                    <!-- chips -->
                    <RowDefinition Height="Auto"/>
                    <!-- botão -->
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" SharedSizeGroup="col"/>
                    <ColumnDefinition Width="*" SharedSizeGroup="col"/>
                </Grid.ColumnDefinitions>

                <!-- Título + Toggle -->
                <DockPanel Grid.Row="0" Grid.ColumnSpan="2" LastChildFill="False" Margin="0,0,0,12">
                    <TextBlock Text="Novo Lançamento" Foreground="White" FontSize="16" FontWeight="Bold" />
                    <StackPanel Orientation="Horizontal" Margin="16,0,0,0">
                        <RadioButton x:Name="rbPagamento" Content="Pagamento" Margin="0,0,8,0" Foreground="White"
                     IsChecked="{Binding TipoLancamento, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=Pagamento}"/>
                        <RadioButton x:Name="rbProduto" Content="Produto" Foreground="White"
                     IsChecked="{Binding TipoLancamento, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=Produto}"/>
                    </StackPanel>
                </DockPanel>

                <!-- ====== PAGAMENTO ====== -->
                <Grid Grid.Row="1" Grid.ColumnSpan="2"
                    Visibility="{Binding ElementName=rbPagamento, Path=IsChecked, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" SharedSizeGroup="col"/>
                        <ColumnDefinition Width="*" SharedSizeGroup="col"/>
                    </Grid.ColumnDefinitions>

                    <!-- Data -->
                    <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,12,8">
                        <TextBlock Text="Data" Foreground="#BBB" Margin="0,0,0,4"/>
                        <hc:DatePicker SelectedDate="{Binding NovoPagamento.DataPagamento, Mode=TwoWay, ValidatesOnDataErrors=True, NotifyOnValidationError=True}"/>
                    </StackPanel>

                    <!-- Método -->
                    <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,0,8">
                        <TextBlock Text="Método" Foreground="#BBB" Margin="0,0,0,4"/>
                        <ComboBox ItemsSource="{Binding Metodo}" 
                  SelectedItem="{Binding NovoPagamento.Metodo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}"
                  hc:InfoElement.Placeholder="PIX, Crédito..." />
                    </StackPanel>

                    <!-- Valor -->
                    <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,12,0">
                        <TextBlock Text="Valor" Foreground="#BBB" Margin="0,0,0,4"/>
                        <hc:TextBox Width="180">
                            <hc:TextBox.Text>
                                <Binding Path="NovoPagamento.Valor" Mode="TwoWay" UpdateSourceTrigger="PropertyChanged"
                     ConverterCulture="pt-BR" ValidatesOnExceptions="True" NotifyOnValidationError="True"/>
                            </hc:TextBox.Text>
                        </hc:TextBox>
                    </StackPanel>

                    <!-- Observação -->
                    <StackPanel Grid.Row="1" Grid.Column="1">
                        <TextBlock Text="Observação" Foreground="#BBB" Margin="0,0,0,4"/>
                        <TextBox Text="{Binding NovoPagamento.Observacao, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                 AcceptsReturn="True" TextWrapping="Wrap" MinHeight="32"/>
                    </StackPanel>
                </Grid>

                <!-- Chips de valor rápido -->
                <StackPanel Grid.Row="3" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,8,0,0"
            Visibility="{Binding ModoProduto, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                    <TextBlock Text="Atalhos:" Foreground="#BBB" Margin="0,4,8,0"/>
                    <WrapPanel>
                        <Button Content="R$ 20,00" Margin="0,0,6,0"
                Command="{Binding DefinirValorRapidoCommand}">
                            <Button.CommandParameter>
                                <sys:Decimal xmlns:sys="clr-namespace:System;assembly=mscorlib">20</sys:Decimal>
                            </Button.CommandParameter>
                        </Button>
                        <Button Content="R$ 60,00" Margin="0,0,6,0"
                Command="{Binding DefinirValorRapidoCommand}">
                            <Button.CommandParameter>
                                <sys:Decimal xmlns:sys="clr-namespace:System;assembly=mscorlib">60</sys:Decimal>
                            </Button.CommandParameter>
                        </Button>
                        <Button Content="R$ 80,00" Margin="0,0,6,0"
                Command="{Binding DefinirValorRapidoCommand}">
                            <Button.CommandParameter>
                                <sys:Decimal xmlns:sys="clr-namespace:System;assembly=mscorlib">80</sys:Decimal>
                            </Button.CommandParameter>
                        </Button>
                        <Button Content="R$ 100,00" Margin="0,0,6,0"
                Command="{Binding DefinirValorRapidoCommand}">
                            <Button.CommandParameter>
                                <sys:Decimal xmlns:sys="clr-namespace:System;assembly=mscorlib">100</sys:Decimal>
                            </Button.CommandParameter>
                        </Button>
                    </WrapPanel>
                </StackPanel>
                
                <StackPanel Grid.Row="1" Grid.ColumnSpan="2" VerticalAlignment="Bottom" HorizontalAlignment="Right" Orientation="Horizontal" Margin="0,0,5,0"
            Visibility="{Binding ElementName=rbProduto, Path=IsChecked, Converter={StaticResource BoolToVisibilityConverter}}">
                    <TextBlock Text="Atalhos:" Foreground="#BBB" Margin="0,5,12,0"/>

                    <WrapPanel>
                        <Button Content="2×" Margin="0,0,6,0"
                Command="{Binding DefinirQuantidadeRapidaCommand}">
                            <Button.CommandParameter>
                                <sys:Int32 xmlns:sys="clr-namespace:System;assembly=mscorlib">2</sys:Int32>
                            </Button.CommandParameter>
                        </Button>
                        <Button Content="5×" Margin="0,0,6,0"
                Command="{Binding DefinirQuantidadeRapidaCommand}">
                            <Button.CommandParameter>
                                <sys:Int32 xmlns:sys="clr-namespace:System;assembly=mscorlib">5</sys:Int32>
                            </Button.CommandParameter>
                        </Button>
                        <Button Content="10×" Margin="0,0,6,0"
                Command="{Binding DefinirQuantidadeRapidaCommand}">
                            <Button.CommandParameter>
                                <sys:Int32 xmlns:sys="clr-namespace:System;assembly=mscorlib">10</sys:Int32>
                            </Button.CommandParameter>
                        </Button>
                    </WrapPanel>
                </StackPanel>


                <!-- CTA -->
                <StackPanel Grid.Row="4" Grid.ColumnSpan="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,12,0,0">
                    <Button Padding="12,6" Background="#4CAF50" Foreground="White" FontWeight="Bold" BorderThickness="0">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Content" Value="Adicionar Pagamento"/>
                                <Setter Property="Command" Value="{Binding SalvarOuAdicionarHistoricoCommand}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ElementName=rbProduto, Path=IsChecked}" Value="True">
                                        <Setter Property="Content" Value="Adicionar Produto"/>
                                        <Setter Property="Command" Value="{Binding AdicionarProdutoCommand}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
                

                <!-- ====== PRODUTO (mantém seu layout, mas em 2 colunas) ====== -->
                <Grid Grid.Row="1" Grid.ColumnSpan="2"
          Visibility="{Binding ElementName=rbProduto, Path=IsChecked, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" SharedSizeGroup="col"/>
                        <ColumnDefinition Width="*" SharedSizeGroup="col"/>
                    </Grid.ColumnDefinitions>

                    <!-- Produto -->
                    <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,12,8">
                        <TextBlock Text="Produto" Foreground="#BBB" Margin="0,0,0,4"/>
                        <ComboBox ItemsSource="{Binding ProdutosDisponiveis}"
                  DisplayMemberPath="Nome"
                  SelectedItem="{Binding ProdutoSelecionado, Mode=TwoWay}" 
                  hc:InfoElement.Placeholder="Selecione..." />
                    </StackPanel>

                    <!-- Quantidade -->
                    <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,0,8">
                        <TextBlock Text="Quantidade" Foreground="#BBB" Margin="40,0,0,4"/>
                        <hc:NumericUpDown
            Value="{Binding NovoProduto.Quantidade, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
            Minimum="1" Maximum="999" Height="30" Width="120"/>
                    </StackPanel>

                    <!-- Valor Unitário (auto) -->
                    <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,12,0">
                        <TextBlock Text="Valor Unitário" Foreground="#BBB" Margin="0,0,0,4"/>
                        <TextBox Width="180" IsReadOnly="True"
                 Text="{Binding NovoProduto.ValorUnitario, Mode=TwoWay, StringFormat=R$ {0:N2}}"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>

        

        <!-- HISTÓRICO -->
        <Border Grid.Row="5" Height="300" Background="#3A3A3A" CornerRadius="12" Padding="10">
            <DockPanel>
                <TextBlock Text="Histórico de Pagamentos" Foreground="White" FontWeight="Bold" FontSize="16" DockPanel.Dock="Top"/>
                <DataGrid ItemsSource="{Binding Historico}"
                          AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False"
                          EnableRowVirtualization="True" EnableColumnVirtualization="True"
                          Width="900" HorizontalAlignment="Left"
                          Margin="0,8,0,0" RowHeaderWidth="0"
                          SelectedItem="{Binding ItemSelecionado}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Data" Binding="{Binding Data, StringFormat=dd/MM/yyyy}" Width="*" />
                        <DataGridTextColumn Header="Método" Binding="{Binding Metodo, TargetNullValue=—}" Width="*" />
                        <DataGridTextColumn Header="Observ." Binding="{Binding Descricao}" Width="2*" />
                        <DataGridTextColumn Header="Valor" Binding="{Binding Valor, StringFormat=R$ {0:N2}}" Width="*" />
                        <DataGridTemplateColumn Header="" Width="140">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <Button Content="Editar" Margin="0,0,6,0" Background="#E8FCFF"
                                                Command="{Binding DataContext.SelecionarHistoricoParaEdicaoCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding}"/>
                                        <Button Content="Excluir" Background="#FFFFA6A6"
                                                Command="{Binding DataContext.ExcluirPagamentoCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>
        </Border>
    </Grid>
</UserControl>
